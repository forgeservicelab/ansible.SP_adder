#!/usr/bin/python
# -*- coding: utf-8 -*-

try:
    from lxml import etree
except ImportError:
    print ("failed=True msg='lxml is required'")


def _retrieve_metadata(module):
    metadata = """$metadata['{name}'] = array (
  'AssertionConsumerService' => '{acs}',
  'SingleLogoutService' => '{ls}',
);"""
    tree = etree.XML(module.params['html'])
    name = tree.attrib['entityID'] if 'entityID' in tree.attrib.keys() else None
    acs = None
    ls = None
    acsElement = tree.find('.//md:AssertionConsumerService', namespaces=tree.nsmap)
    acs = acsElement.attrib['Location'] if acsElement is not None and 'Location' in acsElement.attrib.keys() else None
    lsElement = tree.find('.//md:SingleLogoutService', namespaces=tree.nsmap)
    ls = lsElement.attrib['Location'] if lsElement is not None and 'Location' in lsElement.attrib.keys() else None

    if all([name, ls, acs]):
        module.exit_json(changed=False, metadata=metadata.format(acs=acs, ls=ls, name=name))
    else:
        module.fail_json(msg='No metadata found')


def main():
    module = AnsibleModule(
        argument_spec=dict(
            html=dict(required=True)
        )
    )

    _retrieve_metadata(module)

# This is magic, see Ansible docs.
from ansible.module_utils.basic import *
main()
